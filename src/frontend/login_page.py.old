"""
Login page for Prompt2Mesh application
"""
import streamlit as st
import requests
import time
import os
import sys
from typing import Optional
from pathlib import Path

# Add parent directory to path for imports
parent_dir = Path(__file__).parent.parent
sys.path.insert(0, str(parent_dir))

from config import get_backend_url

# Backend API configuration
BACKEND_URL = get_backend_url()


def check_backend_status() -> bool:
    """Check if backend server is online"""
    try:
        response = requests.get(f"{BACKEND_URL}/", timeout=2)
        return response.status_code == 200
    except Exception:
        return False


def login_user(username: str, password: str) -> Optional[dict]:
    """
    Authenticate user with backend
    
    Returns:
        Dict with token and user info if successful, None otherwise
    """
    try:
        response = requests.post(
            f"{BACKEND_URL}/auth/login",
            json={"username": username, "password": password},
            timeout=30  # Increased timeout for container creation
        )
        
        if response.status_code == 200:
            data = response.json()
            if data.get("success"):
                return data
        
        return None
    
    except Exception as e:
        st.error(f"Error connecting to backend: {str(e)}")
        return None


def verify_token(token: str) -> bool:
    """Verify if token is still valid"""
    try:
        response = requests.post(
            f"{BACKEND_URL}/auth/verify",
            json={"token": token},
            timeout=5
        )
        
        if response.status_code == 200:
            data = response.json()
            return data.get("valid", False)
        
        return False
    
    except Exception:
        return False


def logout_user(token: str) -> bool:
    """Logout user by invalidating token and removing container"""
    try:
        response = requests.post(
            f"{BACKEND_URL}/auth/logout",
            json={"token": token},
            timeout=10  # Increased timeout for container cleanup
        )
        
        return response.status_code == 200
    
    except Exception:
        return False


def main():
    """Main login page"""
    st.set_page_config(
        page_title="Prompt2Mesh - Login",
        page_icon="ğŸ”",
        layout="centered",
        initial_sidebar_state="collapsed"
    )
    
    # Initialize session state
    if "authenticated" not in st.session_state:
        st.session_state.authenticated = False
    if "token" not in st.session_state:
        st.session_state.token = None
    if "username" not in st.session_state:
        st.session_state.username = None
    if "user_id" not in st.session_state:
        st.session_state.user_id = None
    if "blender_ui_url" not in st.session_state:
        st.session_state.blender_ui_url = None
    if "mcp_port" not in st.session_state:
        st.session_state.mcp_port = None
    if "blender_ui_port" not in st.session_state:
        st.session_state.blender_ui_port = None
    
    # Check if already authenticated
    if st.session_state.authenticated and st.session_state.token:
        # Verify token is still valid
        if verify_token(st.session_state.token):
            st.success(f"âœ… Already logged in as **{st.session_state.username}**")
            
            col1, col2 = st.columns(2)
            
            with col1:
                if st.button("ğŸ¨ Go to Artisan Agent", use_container_width=True):
                    st.switch_page("pages/1_ğŸ”’_Artisan_Agent.py")
            
            with col2:
                if st.button("ğŸšª Logout", use_container_width=True):
                    logout_user(st.session_state.token)
                    # Clear all session state
                    st.session_state.authenticated = False
                    st.session_state.token = None
                    st.session_state.username = None
                    if 'user_id' in st.session_state:
                        del st.session_state.user_id
                    if 'blender_ui_url' in st.session_state:
                        del st.session_state.blender_ui_url
                    if 'mcp_port' in st.session_state:
                        del st.session_state.mcp_port
                    if 'blender_ui_port' in st.session_state:
                        del st.session_state.blender_ui_port
                    if 'connected' in st.session_state:
                        del st.session_state.connected
                    st.success("ğŸ—‘ï¸ Logged out and container removed")
                    st.rerun()
            
            return
        else:
            # Token expired, clear session
            st.session_state.authenticated = False
            st.session_state.token = None
            st.session_state.username = None
    
    # Display login form
    st.title("ğŸ” Prompt2Mesh Login")
    st.markdown("---")
    
    # Check backend status
    backend_online = check_backend_status()
    
    if backend_online:
        st.success("âœ… Backend server is online")
    else:
        st.error("âŒ Backend server is offline. Please start the backend server first.")
        st.code("python src/backend/backend_server.py", language="bash")
        return
    
    # Login form
    st.subheader("Sign In")
    
    with st.form("login_form"):
        username = st.text_input("Username", placeholder="Enter your username")
        password = st.text_input("Password", type="password", placeholder="Enter your password")
        
        submit_button = st.form_submit_button("ğŸ”‘ Login", use_container_width=True)
        
        if submit_button:
            if not username or not password:
                st.error("Please enter both username and password")
            else:
                with st.spinner("ğŸ” Authenticating and setting up your Blender instance..."):
                    result = login_user(username, password)
                    
                    if result:
                        # Store authentication info in session state
                        st.session_state.authenticated = True
                        st.session_state.token = result["token"]
                        st.session_state.username = result["username"]
                        st.session_state.user_id = result.get("user_id")
                        st.session_state.blender_ui_url = result.get("blender_ui_url")
                        st.session_state.mcp_port = result.get("mcp_port")
                        st.session_state.blender_ui_port = result.get("blender_ui_port")
                        
                        st.success(f"âœ… Welcome, {result['username']}!")
                        
                        # Show Blender UI info if available
                        if result.get("blender_ui_url"):
                            st.info(f"ğŸ¨ Your Blender instance: {result['blender_ui_url']}")
                            st.markdown(f"**[ğŸš€ Open Blender UI]({result['blender_ui_url']})**", unsafe_allow_html=True)
                            st.caption("Click the link above to open your Blender interface in a new tab")
                        else:
                            st.warning("â³ Your Blender container is being created. It will be ready in ~10-15 seconds.")
                            st.caption("You can proceed to the app. Your Blender instance will be available shortly.")
                        
                        time.sleep(2)
                        
                        # Redirect to artisan page
                        st.switch_page("pages/1_ğŸ”’_Artisan_Agent.py")
                    else:
                        st.error("âŒ Invalid username or password")
    
    # Info section
    st.markdown("---")
    
    st.markdown("Don't have an account?")
    if st.button("ğŸ“ Create New Account", use_container_width=True):
        st.switch_page("pages/0_signup_page.py")
    
    st.markdown("---")
    
    st.info("""
    **Default Credentials:**
    - Username: `root`
    - Password: `root`
    
    *Note: These credentials are stored securely in the PostgreSQL database.*
    """)


if __name__ == "__main__":
    main()
