#!/usr/bin/with-contenv bash
# MCP Auto-Start Init Script
# This script sets up the Blender autostart to enable MCP automatically

echo "=================================="
echo "ðŸš€ Blender MCP Auto-Start Init"
echo "=================================="

# Ensure custom-cont-init.d exists
mkdir -p /config/custom-cont-init.d

# This script modifies the openbox autostart to include MCP auto-enable
AUTOSTART_FILE="/config/.config/openbox/autostart"

# Check if autostart file exists
if [ ! -f "$AUTOSTART_FILE" ]; then
    echo "âš ï¸  Autostart file not found, creating..."
    mkdir -p /config/.config/openbox
    echo "DRI_PRIME=1 blender &" > "$AUTOSTART_FILE"
fi

# Check if our MCP start command is already there
if grep -q "enable_addon_auto.py" "$AUTOSTART_FILE"; then
    echo "âœ… MCP auto-start already configured in autostart"
else
    echo "ðŸ”§ Adding MCP auto-start to openbox autostart..."
    
    # Backup original
    cp "$AUTOSTART_FILE" "${AUTOSTART_FILE}.backup.$(date +%Y%m%d_%H%M%S)"
    
    # Create new autostart with MCP enable
    cat > "$AUTOSTART_FILE" << 'EOF'
#!/bin/bash
# Start Blender
DRI_PRIME=1 blender &
BLENDER_PID=$!

# Auto-enable MCP in background
(
    sleep 25
    echo "[$(date)] ðŸ”§ Auto-enabling MCP addon..." >> /tmp/mcp_autostart.log
    if [ -f "/tmp/enable_addon_auto.py" ]; then
        blender --background --python /tmp/enable_addon_auto.py >> /tmp/mcp_autostart.log 2>&1
        if [ $? -eq 0 ]; then
            echo "[$(date)] âœ… MCP addon enabled successfully" >> /tmp/mcp_autostart.log
        else
            echo "[$(date)] âš ï¸  MCP enable failed" >> /tmp/mcp_autostart.log
        fi
    fi
) &

wait $BLENDER_PID
EOF

    chmod +x "$AUTOSTART_FILE"
    chown abc:abc "$AUTOSTART_FILE"
    
    echo "âœ… Autostart configured successfully"
    echo "ðŸ“‹ MCP logs will be in: /tmp/mcp_autostart.log"
fi

echo "=================================="
echo "âœ… MCP Auto-Start Init Complete"
echo "=================================="
