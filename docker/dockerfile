# Multi-stage Dockerfile for Prompt2Mesh
# This dockerfile supports multiple build targets for different services

# ==============================================================================
# Stage: backend - FastAPI Backend and Streamlit Frontend
# ==============================================================================
FROM python:3.12-slim as backend

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    libpq-dev \
    postgresql-client \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements and install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip setuptools wheel
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY src/ /app/src/
COPY init_db.py /app/
COPY main.py /app/
COPY .env.example /app/.env.example

# Create necessary directories
RUN mkdir -p /app/requirements /app/screenshots /app/logs

# Expose ports
EXPOSE 8000 8501

# Default command
CMD ["python3", "src/backend/backend_server.py"]

# ==============================================================================
# Stage: blender - Blender with Python environment (if needed in future)
# ==============================================================================
FROM linuxserver/blender:latest as blender

# Set environment variables
ENV PUID=1000 \
    PGID=1000 \
    TZ=America/New_York \
    PYTHONUNBUFFERED=1

# Install Python and PostgreSQL client
USER root
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-dev \
    libpq-dev \
    postgresql-client \
    curl \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy requirements and install Python dependencies
COPY requirements.txt .
RUN pip3 install --no-cache-dir --break-system-packages --upgrade pip setuptools wheel
RUN pip3 install --no-cache-dir --break-system-packages -r requirements.txt

# Copy application code
COPY src/ /app/src/
COPY init_db.py /app/
COPY .env.example /app/.env.example
COPY docker/start-blender-k8s.sh /app/start-blender-k8s.sh

# Copy Blender addon to temporary location (will be copied to /config on startup)
RUN mkdir -p /tmp/blender_mcp_addon
COPY src/addon/ /tmp/blender_mcp_addon/
COPY src/blender_mcp/ /app/src/blender_mcp/
COPY docker/mcp_autostart.py /tmp/mcp_autostart.py

# Create necessary directories
RUN mkdir -p /app/requirements /app/screenshots /app/logs

# Set permissions
RUN chown -R abc:abc /app && \
    chown -R abc:abc /tmp/blender_mcp_addon && \
    chmod +x /app/start-blender-k8s.sh

# Expose ports
EXPOSE 3000 3001 9876

# For Kubernetes: use the startup script that initializes web services
# For Docker Compose: will override with docker-compose command
CMD ["/app/start-blender-k8s.sh"]
