# Multi-stage Dockerfile for Prompt2Mesh
# This Dockerfile supports multiple build targets for different services

# ==============================================================================
# Stage: backend - FastAPI Backend and Streamlit/Frontend
# ==============================================================================
FROM python:3.12-slim AS backend

# Set working directory
WORKDIR /app

# Environment settings
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

# Install system dependencies (single RUN + cleanup for smaller, cleaner images)
RUN apt-get update && apt-get install -y \
    build-essential \
    libpq-dev \
    postgresql-client \
    curl \
 && rm -rf /var/lib/apt/lists/*

# Copy requirements and install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip setuptools wheel \
 && pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY src/ /app/src/
COPY init_db.py /app/
COPY .env.example /app/.env.example

# Create necessary directories and non-root user
RUN mkdir -p /app/requirements /app/screenshots /app/logs \
 && useradd -m abc \
 && chown -R abc:abc /app

# Switch to non-root user for better security
USER abc

# Expose ports:
# 8000  - backend API
# 3000  - optional frontend (if you run Streamlit/other UI on 3000)
# 8501  - default Streamlit port (if you use it)
# 9876  - optional Blender bridge port
EXPOSE 8000 3000 8501 9876

# Default command: backend API server
# Make sure src/backend/backend_server.py binds to 0.0.0.0:8000
CMD ["python3", "src/backend/backend_server.py"]


# ==============================================================================
# Stage: blender - Blender image + Python environment (for future use)
# ==============================================================================
FROM linuxserver/blender:latest AS blender

# Base env (linuxserver.io style)
ENV PUID=1000 \
    PGID=1000 \
    TZ=America/New_York \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1

# Switch to root to install extra dependencies
USER root

# Install Python and PostgreSQL client tools
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-dev \
    libpq-dev \
    postgresql-client \
    curl \
 && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy requirements and install Python dependencies
COPY requirements.txt .
RUN pip3 install --no-cache-dir --upgrade pip setuptools wheel \
 && pip3 install --no-cache-dir -r requirements.txt

# Copy application code
COPY src/ /app/src/
COPY init_db.py /app/
COPY .env.example /app/.env.example
COPY docker/backend-run.sh /app/backend-run.sh

# Create s6-overlay service for backend
RUN mkdir -p /etc/services.d/backend \
 && echo '#!/usr/bin/with-contenv sh' > /etc/services.d/backend/run \
 && echo 'cd /app' >> /etc/services.d/backend/run \
 && echo 'exec s6-setuidgid abc /lsiopy/bin/python3 src/backend/backend_server.py' >> /etc/services.d/backend/run \
 && chmod +x /etc/services.d/backend/run \
 && chmod +x /app/backend-run.sh

# Create necessary directories
RUN mkdir -p /app/requirements /app/screenshots /app/logs \
 && chown -R abc:abc /app

# Expose ports relevant to services that might run in this image
# 3000/8501 - UI (if you run a frontend here)
# 8000      - internal API
# 9876      - Blender bridge server
EXPOSE 3000 8501 8000 9876

# Use the s6-overlay init system (default for linuxserver/blender)
# The backend service will be started automatically
