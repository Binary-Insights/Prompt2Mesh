#!/bin/sh
# 99-mcp-addon-setup
# This script sets up the MCP addon to auto-enable

echo "=================================="
echo "ðŸš€ MCP Addon Setup"
echo "=================================="

# Wait longer for linuxserver init to complete and create config directories
sleep 10

# Find the Blender version directory (check multiple times)
for i in {1..5}; do
    BLENDER_VERSION_DIR=$(find /config/.config/blender -maxdepth 1 -type d -name "[0-9]*" 2>/dev/null | sort -V | tail -1)
    
    if [ -n "$BLENDER_VERSION_DIR" ]; then
        break
    fi
    
    echo "â³ Waiting for Blender config directory... (attempt $i/5)"
    sleep 3
done

if [ -z "$BLENDER_VERSION_DIR" ]; then
    echo "âš ï¸  Blender config directory not found, creating from defaults..."
    
    # Try to create from defaults for both versions
    for VERSION in 4.2 5.0; do
        if [ -d "/defaults/.config/blender/$VERSION" ]; then
            mkdir -p "/config/.config/blender/$VERSION"
            cp -r "/defaults/.config/blender/$VERSION"/* "/config/.config/blender/$VERSION/" 2>/dev/null || true
            chown -R abc:abc "/config/.config/blender/$VERSION"
            echo "âœ… Created config for Blender $VERSION"
        fi
    done
    
    # Try to find again
    BLENDER_VERSION_DIR=$(find /config/.config/blender -maxdepth 1 -type d -name "[0-9]*" 2>/dev/null | sort -V | tail -1)
fi

if [ -z "$BLENDER_VERSION_DIR" ]; then
    echo "âŒ Could not create Blender config directory"
    exit 1
fi

echo "ðŸ“ Found Blender config: $BLENDER_VERSION_DIR"

# Create addons directory
ADDON_DIR="$BLENDER_VERSION_DIR/scripts/addons"
mkdir -p "$ADDON_DIR"
chown -R abc:abc "$BLENDER_VERSION_DIR/scripts"

# Remove any old addon files to avoid conflicts
echo "ðŸ§¹ Cleaning up old addon files..."
rm -f "$ADDON_DIR/blender_mcp_addon.py" 2>/dev/null || true
rm -rf "$ADDON_DIR/blender_mcp" 2>/dev/null || true

# Copy MCP addon as a Python package
echo "ðŸ“¦ Setting up MCP addon package..."
ADDON_COPIED=false

# Create addon package directory
ADDON_PKG_DIR="$ADDON_DIR/blender_mcp"
mkdir -p "$ADDON_PKG_DIR"
chown abc:abc "$ADDON_PKG_DIR"

# Try to find the addon from defaults
for DEFAULT_DIR in /defaults/.config/blender/*/scripts/addons/blender_mcp_addon.py; do
    if [ -f "$DEFAULT_DIR" ]; then
        # Copy as __init__.py to make it a proper Python package
        cp "$DEFAULT_DIR" "$ADDON_PKG_DIR/__init__.py"
        chown abc:abc "$ADDON_PKG_DIR/__init__.py"
        chmod 644 "$ADDON_PKG_DIR/__init__.py"
        echo "âœ… MCP addon copied from $DEFAULT_DIR"
        ADDON_COPIED=true
        break
    fi
done

if [ "$ADDON_COPIED" = false ]; then
    echo "âŒ Failed to copy MCP addon - source not found"
    exit 1
fi

# Verify the addon was copied
if [ -f "$ADDON_PKG_DIR/__init__.py" ]; then
    ADDON_SIZE=$(stat -f%z "$ADDON_PKG_DIR/__init__.py" 2>/dev/null || stat -c%s "$ADDON_PKG_DIR/__init__.py" 2>/dev/null)
    echo "âœ… MCP addon package present: $ADDON_PKG_DIR/__init__.py (${ADDON_SIZE} bytes)"
else
    echo "âŒ MCP addon file not found after copy!"
    exit 1
fi

# Create Python startup script to auto-enable addon
STARTUP_DIR="$BLENDER_VERSION_DIR/scripts/startup"
mkdir -p "$STARTUP_DIR"
chown -R abc:abc "$STARTUP_DIR"

cat > "$STARTUP_DIR/enable_mcp.py" << 'EOFPYTHON'
import bpy

def enable_mcp_addon():
    """Auto-enable MCP addon on Blender startup"""
    try:
        addon_name = "blender_mcp"
        
        # Check if addon is already enabled
        if addon_name not in bpy.context.preferences.addons:
            # Enable the addon
            bpy.ops.preferences.addon_enable(module=addon_name)
            # Save preferences
            bpy.ops.wm.save_userpref()
            print(f"âœ… MCP addon '{addon_name}' enabled successfully")
        else:
            print(f"â„¹ï¸ MCP addon '{addon_name}' already enabled")
        
        return True
    except Exception as e:
        print(f"âš ï¸ Failed to enable MCP addon: {e}")
        return False

# Register the function to run on startup
if __name__ == "__main__":
    enable_mcp_addon()

# Also register it to run when Blender fully starts
bpy.app.timers.register(enable_mcp_addon, first_interval=2.0)
EOFPYTHON

chown abc:abc "$STARTUP_DIR/enable_mcp.py"
chmod 644 "$STARTUP_DIR/enable_mcp.py"

echo "âœ… MCP addon startup script created at $STARTUP_DIR/enable_mcp.py"
echo "=================================="
echo "âœ… MCP Addon Setup Complete"
echo "   Addon location: $ADDON_PKG_DIR/__init__.py"
echo "   Startup script: $STARTUP_DIR/enable_mcp.py"
echo "=================================="
